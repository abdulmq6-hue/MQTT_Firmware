%% ATG Monitoring System - EMQX ACL Configuration
%% Access Control Rules for MQTT Topics

%% Format: {permission, who, action, topics}.
%% permission: allow | deny
%% who: all | {user, "username"} | {client, "clientid"} | {ipaddr, "ip"} | {ipaddrs, ["ip1", "ip2"]}
%% action: subscribe | publish | all
%% topics: list of topics or topic patterns

%% ========================================
%% Backend Service - Full Access
%% ========================================
{allow, {user, "backend_service"}, subscribe, ["atg/#", "sys/#", "cmd/#"]}.
{allow, {user, "backend_service"}, publish, ["atg/#", "sys/#", "cmd/#"]}.

{allow, {user, "admin"}, subscribe, ["#"]}.
{allow, {user, "admin"}, publish, ["#"]}.

%% ========================================
%% ATG Devices - Limited Access
%% ========================================
%% Devices can publish to their own telemetry and status topics
{allow, {user, "device_83731"}, publish, ["atg/+/83731/telemetry", "atg/+/83731/status", "ATG83731"]}.
{allow, {user, "device_83731"}, subscribe, ["cmd/+/83731/#"]}.

%% Generic device pattern (for all ATG devices)
%% Devices with username pattern "device_*" can publish to matching topics
{allow, {clientid, "ATG*"}, publish, ["ATG+", "atg/+/+/telemetry", "atg/+/+/status"]}.
{allow, {clientid, "ATG*"}, subscribe, ["cmd/+/+/#"]}.

%% ========================================
%% Web Dashboard Users - Read Only
%% ========================================
{allow, {user, "dashboard"}, subscribe, ["atg/#", "sys/devices/#"]}.
{deny, {user, "dashboard"}, publish, ["#"]}.

%% ========================================
%% System Topics
%% ========================================
%% Allow backend to monitor system events
{allow, {user, "backend_service"}, subscribe, ["$SYS/#"]}.

%% ========================================
%% Default Rule - Deny All
%% ========================================
%% Must be last - deny everything else
{deny, all, all, ["#"]}.
